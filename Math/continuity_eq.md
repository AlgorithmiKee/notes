---
title: "Continuity Equation"
date: "2025"
author: "Ke Zhang"
---

# Continuity Equation

[toc]

The continuity equation is a first-order partial differential equation expressing local mass conservation in  fluid mechanics. It can be understood from two perspectives:

* Eulerian perspective: Intutively, we observe the fluid at a fixed location and at a fixed time. We describe the local change.
* Lagrange perspective: Trace a single particle along the flow.

## Eulerian Perspective

In Eulerian perspective, a fluid is described by its density and velocity. We observe the fluid at a **fixed** spatial point $\mathbf{x}$.

* $\rho(\mathbf{x}, t)$: density at location $\mathbf{x} \in\mathbb R^n$ and time $t$. Time-dependent scalar field.
* $\mathbf{u}(\mathbf{x}, t)$: velocity at location $\mathbf{x} \in\mathbb R^n$ and time $t$. Time-dependent vector field.

W.l.o.g., we assume the time $t \in [0,1]$.

Let $\Omega \subseteq \mathbb{R}^n$ be a fixed **control volume** with boundary $\partial \Omega$. By conservation of mass,

$$
\begin{align}
\frac{\mathrm d}{\mathrm dt} \int_{\Omega} \rho \:\mathrm{d} V
&= - \oint_{\partial\Omega} \rho \mathbf{u} \cdot \mathrm d \mathbf{A}
\end{align}
$$

Remarks:

* This is continuity equation in integral form. It must hold at any location $\mathbf{x}$ and at any time $t$.
* The LHS describes the rate of change of the mass inside the volume $\Omega$.
* The integral on RHS describes the net outflow through the surface $\partial\Omega$. The negative sign indicates that a net outflow decreases the mass within $\Omega$.

On the LHS, we can exchanging the order of integral and time derivative.

$$
\frac{\mathrm d}{\mathrm dt} \int_{\Omega} \rho \:\mathrm{d} V
= \int_{\Omega} \frac{\partial}{\partial t}  \rho \:\mathrm{d} V
$$

On the RHS, we apply the Gaussian integral law.

$$
\oint_{\partial\Omega} \rho \mathbf{u} \:\mathrm d \mathbf{A}
= \int_{\Omega}  \operatorname{div} (\rho \mathbf{u}) \:\mathrm d V
$$

Together,

$$
\begin{align*}
\int_{\Omega} \frac{\partial}{\partial t}  \rho \:\mathrm{d} V
&= - \int_{\Omega}  \operatorname{div} (\rho \mathbf{u}) \:\mathrm d V
\end{align*}
$$

Rearranging the term yields

$$
\begin{align*}
\int_{\Omega} \left[
    \frac{\partial}{\partial t}  \rho + \operatorname{div} (\rho \mathbf{u})
\right]\:\mathrm dV = 0
\end{align*}
$$

This equality must hold for any control volumne $\Omega$. The integrand must thus be zero everywhere. Therefore, we conclude the ***continuity equation*** in differential form.

$$
\begin{align}
\frac{\partial}{\partial t}  \rho + \operatorname{div} (\rho \mathbf{u}) = 0
\end{align}
$$

### Equivalent Formulation using Material Derivative

Using the product rule in multivariate calculus

$$
\operatorname{div} (\rho \mathbf{u}) = \mathbf{u} \cdot \nabla \rho + \rho \operatorname{div} \mathbf{u}
$$

The contiuity equation can be reformulated as

$$
\begin{align}
\frac{\partial \rho}{\partial t} + \mathbf{u} \cdot \nabla \rho + \rho (\operatorname{div} \mathbf{u}) = 0
\end{align}
$$

Remarks:

* The first two terms represent the material derivative of density $\frac{D\rho}{Dt}$, which describes the change in density of a fluid parcel as it moves along the velocity field
  $$
  \begin{align}
  \frac{D\rho}{Dt} \triangleq \frac{\partial \rho}{\partial t} + \mathbf{u} \cdot \nabla \rho
  \end{align}
  $$
* For incompressible flow, the density of a fluid parcel is contant (both in time and space), i.e. $\frac{\partial \rho}{\partial t} = 0$ and $\nabla \rho = \mathbf{0}$. The contiuity equation simplifies to
  $$
  \operatorname{div} \mathbf{u} = 0
  $$

## Lagrangian Perspective

The Lagrange perspective focus on describing the movement of each individual fluid particles. Let $\mathbf{x}(t)$ be the positional vector of a particular (weightless) particle at time $t$. This particle traces a trajectory generated by the ODE

$$
\begin{align}
\dot{\mathbf{x}}(t) = \mathbf{u}(\mathbf{x}(t), t), \quad
\mathbf{x}(0) = \mathbf{x}_0
\end{align}
$$

where

* $\mathbf{u}: \mathbb R^n \times [0,1] \to \mathbb R^n$ is same the time-dependent vector field used in Eulerian perspective.
* $\mathbf{x}_0 \in \mathbb R^n$ is the initial position of the particle at $t=0$.

To describe the movement of all fluid particles, we use the same ODE above but vary $\mathbf{x}_0$. Each distinct initial position yields another trajectory. To encode the trajectories of all particles, we define the ***flow map***:

$$
\begin{align}
\boldsymbol{\phi}: [0,1] \times \mathbb R^n \to \mathbb R^n
\end{align}
$$

s.t.

$$
\begin{align}
\frac{\partial}{\partial t} \boldsymbol{\phi}(t, \mathbf{x}_0)
&= \mathbf{u}(\boldsymbol{\phi}(t, \mathbf{x}_0), t)
\end{align}
$$

Remarks:

* The trajectory $\mathbf{x}(\cdot)$ is the solution to the ODE subject to a specific initial condition. It describes the movement of a single particle.
* The flow map $\boldsymbol{\phi}$ represents the family of solutions to the ODE subject to all possible initial conditions. It describes the movement of all particles.
* $\boldsymbol{\phi}(t, \mathbf{x}_0)$ describes the location of a particle at time $t$ by starting from $\mathbf{x}_0$ and then following the ODE. In particular, $\boldsymbol{\phi}(0, \mathbf{x}_0) = \mathbf{x}_0$.

Consider a collection of particles inside an infinitesimal fluid parcel drifting along the velocity field. Suppose the fluid parcel has initial volume $\mathrm d V_0$ and start drifting at $\mathbf{s}$. At time $t$, the fluid parcel is tranported to location $\boldsymbol{\phi}(t, \mathbf{s})$. The shape of this fluid parcel is also distorted by the velocity field and so does its volume. Let $\mathrm d V_t$ denote the volume of the fluid parcel after drifting time $t$. Then,

$$
\mathrm d V_t = \det \mathbf{F}(t, \mathbf{s}) \ \mathrm d V_0
$$

where $\mathbf{F}$ is the **deformation gradient**, defined as the Jacobian of flow mapping w.r.t. initial location

$$
\mathbf{F}(t, \mathbf{s}) \triangleq \frac{\partial \boldsymbol{\phi}}{\partial\mathbf{x}_0} (t, \mathbf{s}) \in\mathbb R^{n\times n}
$$

**Fact**: The time derivative of deformation gradient is

$$
\begin{align}
\frac{\partial \mathbf{F}}{\partial t} (t, \mathbf{s})
&= \frac{\partial \mathbf{u}}{\partial \mathbf{x}} (\mathbf{x}, t) \, \mathbf{F}(t, \mathbf{s}), \quad \mathbf{x} = \boldsymbol{\phi}(t, \mathbf{s})
\end{align}
$$

or in short hand notation

$$
\begin{align}
\frac{\partial \mathbf{F}}{\partial t}
&= \frac{\partial \mathbf{u}}{\partial \mathbf{x}} \, \mathbf{F}, \quad \mathbf{x} = \boldsymbol{\phi}(t, \mathbf{s})
\end{align}
$$

*Proof*: We assume standard regularity conditions.

$$
\begin{align*}
\frac{\partial \mathbf{F}}{\partial t} (t, \mathbf{s})
&= \frac{\partial}{\partial t} \left(
  \frac{\partial \boldsymbol{\phi}}{\partial\mathbf{x}_0} (t, \mathbf{s})
\right)
&& \text{def. of } \mathbf{F}(t, \mathbf{s})
\\
&= \frac{\partial}{\partial \mathbf{x}_0} \left(
  \frac{\partial}{\partial t} \boldsymbol{\phi}(t, \mathbf{s})
\right)
&& \text{switch order}
\\
&= \frac{\partial}{\partial \mathbf{x}_0} \Big(
  \mathbf{u}(\boldsymbol{\phi}(t, \mathbf{x}_0), t)
\Big)
&& \text{property of flow map}
\\
&= \frac{\partial \mathbf{u}}{\partial \mathbf{x}} (\mathbf{x}, t) \,
   \underbrace{\frac{\partial \boldsymbol{\phi}}{\partial \mathbf{x}_0}(t, \mathbf{s})}_{\mathbf{F}(t, \mathbf{s})},
&& \text{chain rule }, \:
\mathbf{x} \triangleq \boldsymbol{\phi}(t, \mathbf{s})
\tag*{$\blacksquare$}
\end{align*}
$$

In Lagrangian view, we track the density of the fluid parcel staring from $\mathbf{s}$ on the time horizon, denoted by

$$
\rho_L(t, \mathbf{s})
$$

Remarks:

* Each fluid parcel is labeled by its starting position $\mathbf{s}$.
* We assume that the fluid parcel is so small that there is no varitation of density inside the fluid parcel.
* Not to be confused by the density $\rho(\mathbf{x}, t)$ in Eulerian framework, which describes the density at a fixed observation point $\mathbf{x}$.

By the conservation of mass and the deformation of volume,

$$
\begin{align}
\rho_L(t, \mathbf{s}) \ \mathrm d V_t
&= \rho_L(0, \mathbf{s}) \ \mathrm d V_0
\\[3pt]
\rho_L(t, \mathbf{s}) \det \mathbf{F}(t, \mathbf{s}) \ \mathrm d V_0
&= \rho_L(0, \mathbf{s}) \ \mathrm d V_0 \nonumber
\end{align}
$$

We conclude the continuity equation in pure Lagrangian view:

$$
\begin{align}
\rho_L(t, \mathbf{s}) \det \mathbf{F}(t, \mathbf{s})
&= \rho_L(0, \mathbf{s})
\end{align}
$$

Remarks:

* This formula resembles the change of variable law in probability theory:
  $$
  \text{new density} \times \text{volume change factor} = \text{old density}
  $$
* In fluid mechanics, $\det \mathbf{F}$ is always positive because physical flow does not flip the fluid in space. vs. In probability theory, we need the abs of the Jacobain determinant.
* The RHS is a time-independent reference density. Hence, the LHS must be constant across all $t\in[0,1]$.

### Equivalent Formulation in Differential Form

For notational simplicity, we write the Lagrangian continuity equation as

$$
\rho_L \det \mathbf{F} = \text{const.}
$$

Taking the time derivative on both sides of the , we get

$$
\begin{align*}
\frac{\partial}{\partial t} \Big( 
  \rho_L \det \mathbf{F} 
\Big) &= 0
\\
\left(\frac{\partial}{\partial t} \rho_L \right)  \det \mathbf{F} +
\rho_L \left(\frac{\partial}{\partial t} \det\mathbf{F} \right)
&= 0
\end{align*}
$$

where

$$
\begin{align*}
\frac{\partial}{\partial t} \det(\mathbf{F} )
&= \det(\mathbf{F}) \operatorname{tr}\left( \mathbf{F}^{-1} \frac{\partial \mathbf{F}}{\partial t}\right)
&& \text{see matrix cookbook}
\\
&= \det(\mathbf{F}) \operatorname{tr}\left(
  \mathbf{F}^{-1} \left( \frac{\partial\mathbf{u}}{\partial \mathbf{x}}
  \right) \mathbf{F}  \right)
&& \text{property of }\mathbf{F}, \quad \mathbf{x} = \boldsymbol{\phi}(t, \mathbf{s})
\\
&= \det(\mathbf{F}) \operatorname{tr}\left(
    \frac{\partial\mathbf{u}}{\partial \mathbf{x}}
  \right)
&& \operatorname{tr}(ABC) = \operatorname{tr}(CAB)
\\
&= \det(\mathbf{F}) \operatorname{div}(\mathbf{u})
&& \text{easy to verify: } \operatorname{tr}\left(
    \frac{\partial\mathbf{u}}{\partial \mathbf{x}}
   \right) = \operatorname{div}(\mathbf{u})
\end{align*}
$$

Hence,

$$
\begin{align*}
\left(\frac{\partial}{\partial t} \rho_L \right)  \det(\mathbf{F}) +
\rho_L \det(\mathbf{F}) \operatorname{div}(\mathbf{u})
&= 0
\end{align*}
$$

By the positivity of $\det(\mathbf{F})$, we divide both side by $\det(\mathbf{F})$ and conclude:

$$
\begin{align}
\frac{\partial}{\partial t} \rho_L + \rho_L \operatorname{div}(\mathbf{u}) = 0
\end{align}
$$

Remarks:

* Must hold for any time $t\in[0,1]$ and any starting position $\mathbf{s}$.
* Equivalent formulation:
  $$
  \begin{align}
  \frac{\partial}{\partial t} \ln(\rho_L) + \operatorname{div}(\mathbf{u}) = 0
  \end{align}
  $$
* For incompressible flow (i.e. $\operatorname{div}(\mathbf{u}) = 0$), the continuity equation simplifies to
  $$
  \frac{\partial}{\partial t} \rho_L = 0
  $$

## Bridging Eulerian and Lagrangian Views

The density of fluid parcel in Lagrangian view can be expressed as the density in Eulerian view evaluated along the trajectory of the parcel:

$$
\begin{align}
\rho_L(t, \mathbf{s})
&= \left.\rho(\mathbf{x}, t) \right|_{\mathbf{x} = \boldsymbol{\phi}(t, \mathbf{s})} \\
&= \rho(\boldsymbol{\phi}(t, \mathbf{s}), t)
\end{align}
$$

Analogy: How to describe the termperature in a city in 24h?

* Eulerian: For each point $\mathbf{x}$ in the city, let $T(\mathbf{x},t)$ denote the termperature measured at time $t$.
* Lagrangian: For each starting point $\mathbf{s}$ in the city. Record the termprature $T(t, \mathbf{s})$ along some trajectory.

Recall

$$
\begin{align}
\frac{\partial \rho_L}{\partial t} + \rho_L \operatorname{div}(\mathbf{u}) = 0
\end{align}
$$

We express the contiunity equaiton in terms of Eulerian density rather than Lagrangian density

$$
\begin{align*}
\frac{\partial \rho_L}{\partial t}
&= \frac{\partial \rho}{\partial t} + \frac{\partial \rho}{\partial \mathbf{x}} \frac{\partial \mathbf{x}}{\partial t}, \quad
\mathbf{x} = \boldsymbol{\phi}(t, \mathbf{s})
\\
&= \frac{\partial \rho}{\partial t} + \frac{\partial \rho}{\partial \mathbf{x}} \mathbf{u}(\mathbf{x},t)
\\
&= \frac{\partial \rho}{\partial t} + (\nabla \rho)^\top \mathbf{u}(\mathbf{x},t)
\\
&= \frac{\partial \rho}{\partial t} + \nabla \rho \cdot \mathbf{u}(\mathbf{x},t)
\end{align*}
$$

Hence, we obtain the Eulerian continuity equation:

$$
\begin{align}
\frac{\partial \rho}{\partial t} + \nabla \rho \cdot \mathbf{u}(\mathbf{x},t) + \rho \operatorname{div}(\mathbf{u}) = 0
\end{align}
$$

## Appendix

### Notation of Derivative

Let $f: \mathbb R \to \mathbb R, x \mapsto y$ be differentiable everywhere and $a\in\mathbb R$. Then, all following notations denotes the derivative of $f$ evaluated at $a$:

$$
f'(a), \quad
\frac{d}{dx} f(a), \quad
\frac{df}{dx} (a), \quad
\left. f'(x) \right|_{x=a}, \quad
\left. \frac{dy}{dx} \right|_{x=a}
$$

Let $f: \mathbb R^n \to \mathbb R, \mathbf{x} \mapsto \varphi$ be differentiable everywhere and $\mathbf{a}\in\mathbb R^n$. Then, all following notations denotes the partial derivative of $f$ w.r.t. $x_i$ evaluated at $\mathbf{a}$:

$$
\partial_{i} f(\mathbf{a}), \quad
\partial_{x_i} f(\mathbf{a}), \quad
\frac{\partial}{\partial x_i} f(\mathbf{a}), \quad
\frac{\partial f}{\partial x_i} (\mathbf{a})
$$